- name: Correct apt sources - 1
  ansible.builtin.copy:
    content: |
      deb http://deb.debian.org/debian bookworm main contrib
      deb http://deb.debian.org/debian bookworm-updates main contrib
      deb http://security.debian.org/debian-security bookworm-security main contrib
    dest: /etc/apt/sources.list
    backup: true
    mode: preserve

- name: Correct apt sources - 2
  ansible.builtin.copy:
    content: APT::Get::Update::SourceListWarnings::NonFreeFirmware "false";
    dest: /etc/apt/apt.conf.d/no-bookworm-firmware.conf
    mode: u=rw,g=r,o=r

- name: Disable pve-enterprise repository
  ansible.builtin.copy:
    content: '# deb https://enterprise.proxmox.com/debian/pve bookworm pve-enterprise'
    dest: /etc/apt/sources.list.d/pve-enterprise.list
    mode: preserve

- name: Enable pve-no-subscription repository
  ansible.builtin.copy:
    content: deb http://download.proxmox.com/debian/pve bookworm pve-no-subscription
    dest: /etc/apt/sources.list.d/pve-install-repo.list
    mode: u=rw,g=r,o=r

- name: Correct ceph apt sources
  ansible.builtin.copy:
    content: |
      # deb https://enterprise.proxmox.com/debian/ceph-quincy bookworm enterprise
      # deb http://download.proxmox.com/debian/ceph-quincy bookworm no-subscription
      # deb https://enterprise.proxmox.com/debian/ceph-reef bookworm enterprise
      # deb http://download.proxmox.com/debian/ceph-reef bookworm no-subscription
    dest: /etc/apt/sources.list.d/ceph.list
    mode: preserve

- name: Add pve-test repository and disable
  ansible.builtin.copy:
    content: '# deb http://download.proxmox.com/debian/pve bookworm pvetest'
    dest: /etc/apt/sources.list.d/pvetest-for-beta.list
    mode: u=rw,g=r,o=r

- name: Disabling nag - 1
  ansible.builtin.copy:
    content: >
      DPkg::Post-Invoke {
      "dpkg -V proxmox-widget-toolkit | grep -q '/proxmoxlib\.js$';
      if [ $? -eq 1 ]; then { echo 'Removing subscription nag from UI...';
      sed -i '/.*data\.status.*{/{s/\!//;s/active/NoMoreNagging/}'
      /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js; }; fi"; };
    dest: /etc/apt/apt.conf.d/no-nag-script
    mode: u=rw,g=r,o=r

- name: Disabling nag - 2
  shell: apt-get --reinstall install proxmox-widget-toolkit

- name: Disable HA - 1
  ansible.builtin.systemd_service:
    name: pve-ha-lrm
    state: stopped
    enabled: false

- name: Disable HA - 2
  ansible.builtin.systemd_service:
    name: pve-ha-crm
    state: stopped
    enabled: false

- name: Disable corosync
  ansible.builtin.systemd_service:
    name: corosync
    state: stopped
    enabled: false

- name: Update proxmox
  ansible.builtin.apt:
    update-cache: true
    upgrade: dist

- name: Reboot proxmox
  ansible.builtin.reboot:
